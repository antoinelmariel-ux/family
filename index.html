<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Éditeur de Procédures IA Friendly</title>
  <style>
    :root {
      color-scheme: light;
      --primary: #2f4f9f;
      --accent: #f8f9ff;
      --border: #dce0f3;
      --text: #1c2240;
      --muted: #5c6280;
      --warning: #d64545;
      --success: #20895e;
      --bg: #f4f6fb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', 'Inter', 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      background: white;
      padding: 24px 32px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-logo {
      height: 48px;
      width: auto;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .language-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .language-select-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .language-select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
    }

    .new-procedure-btn {
      padding: 10px 18px;
      border-radius: 10px;
      border: none;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(47, 79, 159, 0.2);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .new-procedure-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(47, 79, 159, 0.25);
    }

    .info-card {
      background: var(--accent);
      border: 1px dashed var(--primary);
      color: var(--text);
    }

    .info-card p {
      margin: 0;
      color: var(--muted);
      line-height: 1.5;
    }

    .info-card ul {
      margin: 12px 0 0;
      padding-left: 20px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 340px;
      gap: 24px;
      padding: 24px 32px 64px;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(28, 34, 64, 0.08);
      border: 1px solid var(--border);
    }

    .card h2 {
      margin-top: 0;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card h3 {
      margin-top: 24px;
      font-size: 18px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
    }

    input[type="text"],
    textarea,
    select,
    input[type="date"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      font-family: inherit;
      transition: border 0.2s, box-shadow 0.2s;
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    input:focus,
    textarea:focus,
    select:focus,
    .editor:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(47, 79, 159, 0.15);
    }

    .metadata-grid {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .metadata-group {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      background: #f9faff;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: inset 0 0 0 1px rgba(47, 79, 159, 0.05);
    }

    .metadata-group-header h3 {
      margin: 0;
      font-size: 17px;
    }

    .metadata-group-header p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    .metadata-group-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px 20px;
    }

    .field-hint {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }

    .keyword-input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .keyword-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .keyword-tag {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid transparent;
      background: var(--accent);
      color: var(--primary);
      gap: 8px;
    }

    .keyword-remove {
      appearance: none;
      border: none;
      background: transparent;
      color: inherit;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .keyword-remove:focus {
      outline: none;
      text-decoration: underline;
    }

    .keyword-empty {
      font-size: 13px;
      color: var(--muted);
    }

    .backoffice-card {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .backoffice-description {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .backoffice-section {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
      background: #f7f8ff;
      display: flex;
      flex-direction: column;
      gap: 14px;
      box-shadow: inset 0 0 0 1px rgba(47, 79, 159, 0.08);
    }

    .backoffice-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .backoffice-section-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .backoffice-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .backoffice-controls input[type="text"] {
      flex: 1 1 240px;
      min-width: 200px;
    }

    .backoffice-add-btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(47, 79, 159, 0.25);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .backoffice-add-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(47, 79, 159, 0.25);
    }

    .backoffice-reset-btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
    }

    .option-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .option-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--accent);
      color: var(--primary);
      border: 1px solid rgba(47, 79, 159, 0.25);
      font-size: 13px;
      font-weight: 600;
    }

    .option-pill-remove {
      appearance: none;
      border: none;
      background: none;
      color: var(--warning);
      font-weight: 700;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      font-size: 14px;
    }

    .option-pill-remove:focus {
      outline: none;
      text-decoration: underline;
    }

    .option-empty {
      font-size: 13px;
      color: var(--muted);
    }

    .editor-card {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .toolbar button {
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: var(--accent);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: transform 0.15s, box-shadow 0.15s;
    }

    .toolbar button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(28, 34, 64, 0.12);
    }

    .rational-block {
      border: 1px dashed var(--primary);
      background: rgba(47, 79, 159, 0.08);
      border-radius: 12px;
      padding: 16px 18px;
      margin: 20px 0;
    }

    .rational-block-title {
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 12px;
      margin: 0 0 12px;
      color: var(--primary);
    }

    .rational-block[data-block-type="rationnel"] p {
      margin: 0;
    }

    .editor {
      min-height: 320px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      line-height: 1.6;
      font-size: 15px;
      background: #fff;
      overflow-y: auto;
    }

    .editor h1,
    .editor h2,
    .editor h3,
    .editor h4 {
      font-weight: 700;
      margin-top: 24px;
    }

    .editor ul,
    .editor ol {
      padding-left: 24px;
    }

    .qa-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: #fafbff;
    }

    .qa-actions {
      display: flex;
      justify-content: flex-end;
    }

    .remove-btn {
      background: none;
      border: none;
      color: var(--warning);
      font-weight: 600;
      cursor: pointer;
    }

    .insights {
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: sticky;
      top: 120px;
      max-height: calc(100vh - 140px);
      overflow-y: auto;
    }

    .insight-card {
      border-left: 4px solid var(--primary);
      padding: 16px;
      border-radius: 12px;
      background: #fff;
      box-shadow: inset 0 0 0 1px var(--border);
    }

    .insight-card h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .insight-list {
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      font-size: 14px;
    }

    .guideline-comment-list {
      list-style: none;
      padding-left: 0;
    }

    .guideline-comment-list li + li {
      margin-top: 12px;
    }

    .insight-comment {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .comment-anchor {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--accent);
      color: var(--primary);
      font-weight: 600;
      font-size: 12px;
      border: 1px solid rgba(47, 79, 159, 0.2);
      white-space: nowrap;
    }

    .comment-message {
      flex: 1;
      font-size: 13px;
      line-height: 1.5;
      color: var(--text);
    }

    .export-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 24px;
    }

    .primary-btn,
    .secondary-btn {
      padding: 12px 18px;
      font-size: 15px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }

    .primary-btn {
      background: var(--primary);
      color: white;
    }

    .primary-btn:disabled {
      background: #b0b7d6;
      cursor: not-allowed;
    }

    .secondary-btn {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    .ghost-btn {
      padding: 10px 16px;
      font-size: 15px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      border: 1px dashed rgba(47, 79, 159, 0.6);
      background: transparent;
      color: var(--primary);
      transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }

    .ghost-btn:hover,
    .ghost-btn:focus-visible {
      background: rgba(47, 79, 159, 0.08);
      border-color: rgba(47, 79, 159, 0.85);
      outline: none;
    }

    .warning {
      color: var(--warning);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .backoffice-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 14, 35, 0.55);
      display: none;
      align-items: flex-start;
      justify-content: center;
      padding: 48px 24px;
      z-index: 20;
      overflow-y: auto;
    }

    .backoffice-overlay.open {
      display: flex;
    }

    .backoffice-panel {
      background: #fff;
      border-radius: 18px;
      max-width: 960px;
      width: 100%;
      box-shadow: 0 18px 48px rgba(14, 24, 56, 0.28);
      padding: 32px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      outline: none;
    }

    .backoffice-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .backoffice-panel-header h2 {
      margin: 0;
      font-size: 22px;
    }

    .backoffice-actions {
      justify-content: flex-end;
    }

    .preview-modal {
      position: fixed;
      inset: 0;
      background: rgba(10, 14, 35, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px;
      z-index: 10;
    }

    .preview-content {
      background: white;
      border-radius: 16px;
      max-width: 960px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 12px 36px rgba(14, 24, 56, 0.32);
    }

    .preview-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .preview-body {
      padding: 24px;
      overflow-y: auto;
      background: #f9f9ff;
    }

    pre {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 13px;
    }

    footer {
      background: white;
      border-top: 1px solid var(--border);
      padding: 16px 32px;
      text-align: right;
      font-size: 13px;
      color: var(--muted);
    }

    @media (max-width: 1100px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .insights {
        position: static;
        max-height: none;
      }

      .backoffice-panel {
        max-width: 720px;
        padding: 28px;
      }
    }

    @media (max-width: 600px) {
      header {
        padding: 20px;
        justify-content: flex-start;
      }

      .header-brand {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .header-logo {
        height: 40px;
      }

      .header-actions {
        width: 100%;
        justify-content: flex-start;
      }

      .new-procedure-btn {
        width: 100%;
      }

      .ghost-btn {
        width: 100%;
      }

      .backoffice-overlay {
        padding: 32px 16px;
      }

      .backoffice-panel {
        padding: 24px;
        border-radius: 16px;
      }

      .backoffice-panel-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .backoffice-panel-header h2 {
        font-size: 20px;
      }

      .backoffice-actions {
        width: 100%;
        justify-content: stretch;
      }

      .backoffice-actions .secondary-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="header-brand">
        <img src="./assets/images/lfb-logo.svg" alt="Logo LFB" class="header-logo" />
        <h1 id="header-title">Studio de Procédures IA Friendly</h1>
      </div>
      <div class="header-actions">
        <div class="language-selector">
          <label for="language-select" class="language-select-label" id="language-label">Langue</label>
          <select id="language-select" class="language-select" aria-labelledby="language-label">
            <option value="fr">Français</option>
            <option value="en">English</option>
            <option value="es">Español</option>
          </select>
        </div>
        <button type="button" class="secondary-btn" id="import-btn">Importer un Markdown</button>
        <button type="button" class="ghost-btn" id="backoffice-btn">Gérer le backoffice</button>
        <button type="button" class="new-procedure-btn" id="new-procedure-btn">Nouvelle procédure</button>
      </div>
    </header>
    <div class="layout">
      <div class="content">
        <section class="card info-card" id="start-info">
          <h2 id="start-info-title">Démarrer une nouvelle procédure</h2>
          <p id="start-info-description">
            Pour créer un nouveau document, cliquez sur le bouton « Nouvelle procédure » situé dans l'entête.
            Un canevas vierge sera automatiquement préparé pour vous permettre de renseigner chaque section.
          </p>
          <ul id="start-info-list">
            <li>Complétez les métadonnées pour contextualiser la procédure.</li>
            <li>Rédigez le contenu opérationnel à l'aide de l'éditeur enrichi.</li>
            <li>Finalisez par la session de Questions &amp; Réponses avant l'export.</li>
          </ul>
        </section>
        <section class="card" id="metadata-card">
          <h2 id="metadata-card-title">1. Métadonnées</h2>
          <div class="metadata-grid" id="metadata-groups"></div>
        </section>
        <section class="card editor-card" id="editor-card">
          <h2 id="editor-card-title">2. Contenu de la procédure</h2>
          <div class="toolbar" id="editor-toolbar">
            <button type="button" data-command="formatBlock" data-value="H1">H1</button>
            <button type="button" data-command="formatBlock" data-value="H2">H2</button>
            <button type="button" data-command="formatBlock" data-value="H3">H3</button>
            <button type="button" data-command="formatBlock" data-value="H4">H4</button>
            <button type="button" data-command="bold">Gras</button>
            <button type="button" data-command="italic">Italique</button>
            <button type="button" id="insert-rational-btn">Rationnel</button>
            <button type="button" data-command="insertUnorderedList">Liste à puces</button>
            <button type="button" data-command="insertOrderedList">Liste numérotée</button>
          </div>
          <div class="editor" id="procedure-editor" contenteditable="true" aria-label="Zone d'édition du contenu"></div>
        </section>
        <section class="card" id="qa-card">
          <h2 id="qa-card-title">3. Questions &amp; Réponses</h2>
          <p id="qa-card-description" style="color: var(--muted); font-size: 14px; margin-top: 0;">
            Structurez la session de questions-réponses qui conclura la procédure.
          </p>
          <div class="qa-list" id="qa-list" style="display: flex; flex-direction: column; gap: 16px;"></div>
          <div class="export-actions" style="justify-content: flex-start; margin-top: 16px;">
            <button type="button" class="secondary-btn" id="add-qa-btn">Ajouter une question</button>
          </div>
        </section>
        <section class="card" id="export-card">
          <h2 id="export-card-title">Aperçu &amp; Export</h2>
          <div class="warning" id="blocking-warning" hidden>
            <span id="blocking-warning-text">⚠️ Export impossible tant que les points suivants ne sont pas corrigés :</span>
            <ul class="insight-list" id="blocking-warning-list"></ul>
          </div>
          <div class="export-actions">
            <button type="button" class="secondary-btn" id="preview-btn">Prévisualiser le Markdown</button>
            <button type="button" class="primary-btn" id="export-md-btn">Exporter en Markdown</button>
            <button type="button" class="primary-btn" id="export-pdf-btn">Exporter en PDF</button>
          </div>
        </section>
      </div>
      <aside class="insights">
        <div class="insight-card">
          <h3 id="guidelines-title">Guidelines IA Friendly</h3>
          <p id="guidelines-empty" style="color: var(--muted); margin: 0;">
            Commencez votre rédaction pour recevoir des recommandations.
          </p>
          <ul class="insight-list guideline-comment-list" id="guidelines-list"></ul>
        </div>
        <div class="insight-card">
          <h3 id="glossary-title">Glossaire</h3>
          <p id="glossary-loading" style="color: var(--muted); margin: 0;">Chargement du glossaire…</p>
          <p class="warning" id="glossary-error" hidden></p>
          <ul class="insight-list" id="glossary-list"></ul>
        </div>
      </aside>
    </div>
  </div>
  <footer id="app-version">Version 1.1.23</footer>
  <div class="preview-modal" id="preview-modal" role="dialog" aria-modal="true" aria-labelledby="preview-title" hidden>
    <div class="preview-content">
      <div class="preview-header">
        <h3 id="preview-title" style="margin: 0;">Aperçu Markdown</h3>
        <button type="button" class="secondary-btn" id="close-preview-btn">Fermer</button>
      </div>
      <div class="preview-body">
        <pre id="preview-body"></pre>
      </div>
    </div>
  </div>
  <div class="backoffice-overlay" id="backoffice-overlay" role="dialog" aria-modal="true" aria-labelledby="backoffice-title" hidden>
    <div class="backoffice-panel" role="document" tabindex="-1">
      <div class="backoffice-panel-header">
        <h2 id="backoffice-title">Backoffice — Options des champs</h2>
        <button type="button" class="secondary-btn" id="close-backoffice-btn">Fermer</button>
      </div>
      <p class="backoffice-description">
        Personnalisez les listes de choix proposées dans les menus déroulants du formulaire.
      </p>
      <div id="backoffice-sections"></div>
      <div class="export-actions backoffice-actions">
        <button type="button" class="secondary-btn" id="export-config-btn">Exporter la configuration JSON</button>
      </div>
    </div>
  </div>
  <input type="file" id="import-input" accept=".md,.markdown,text/markdown" hidden />
  <script type="module" src="./app.js"></script>
</body>
</html>
